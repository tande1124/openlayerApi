{"version":3,"sources":["webpack:///./d3.js"],"names":["CanvasLayer","options","super","this","features","svg","d3","select","document","createElement","append","style","datum","attr","getSourceState","READY","render","frameState","const","width","size","height","projection","viewState","d3Projection","geoMercator","scale","translate","d3Path","geoPath","pixelBounds","bounds","pixelBoundsWidth","pixelBoundsHeight","geoBounds","geoBoundsLeftBottom","geoBoundsRightTop","geoBoundsWidth","getExtent","widthResolution","heightResolution","Math","max","resolution","center","extent","node","map","layers","source","layer","target","view","zoom","json","then","us","topojson","feature","objects","counties","addLayer"],"mappings":"2FAAA,sEAQMA,EAAyB,YAC7B,WAAYC,GACVC,OAAM,KAAAD,GAENE,KAAKC,SAAWH,EAAQG,SAExBD,KAAKE,IAAMC,GACRC,OAAOC,SAASC,cAAc,QAC9BC,OAAO,OACPC,MAAM,WAAY,YAErBR,KAAKE,IAAIK,OAAO,QAAQE,MAAMT,KAAKC,UAAUS,KAAK,QAAS,Y,8FAG7D,EAAF,UAAEC,eAAA,WACE,OAAO,IAAYC,OAGrB,EAAF,UAAEC,OAAA,SAAOC,GACLC,IAAMC,EAAQF,EAAWG,KAAK,GACxBC,EAASJ,EAAWG,KAAK,GACzBE,EAAaL,EAAWM,UAAUD,WAClCE,EAAelB,GAAGmB,cAAcC,MAAM,GAAGC,UAAU,CAAC,EAAG,IACzDC,EAAStB,GAAGuB,UAAUP,WAAWE,GAE/BM,EAAcF,EAAOG,OAAO5B,KAAKC,UACjC4B,EAAmBF,EAAY,GAAG,GAAKA,EAAY,GAAG,GACtDG,EAAoBH,EAAY,GAAG,GAAKA,EAAY,GAAG,GAEvDI,EAAY5B,GAAG4B,UAAU/B,KAAKC,UAC9B+B,EAAsB,YAAWD,EAAU,GAAIZ,GAC/Cc,EAAoB,YAAWF,EAAU,GAAIZ,GAC/Ce,EAAiBD,EAAkB,GAAKD,EAAoB,GAC5DE,EAAiB,IACnBA,GAAkB,YAASf,EAAWgB,cAExCpB,IAEMqB,EAAkBF,EAAiBL,EACnCQ,GAHkBJ,EAAkB,GAAKD,EAAoB,IAGxBF,EAErCP,EADIe,KAAKC,IAAIH,EAAiBC,GAClBvB,EAAWM,UAAUoB,WAEjCC,EAAS,YAAS,YAAU3B,EAAW4B,QAASvB,GActD,OAbAE,EACGE,MAAMA,GACNkB,OAAOA,GACPjB,UAAU,CAACR,EAAQ,EAAGE,EAAS,KAElCO,EAASA,EAAON,WAAWE,IACpBrB,KAAKC,UAEZD,KAAKE,IAAIQ,KAAK,QAASM,GACvBhB,KAAKE,IAAIQ,KAAK,SAAUQ,GAExBlB,KAAKE,IAAIE,OAAO,QAAQM,KAAK,IAAKe,GAE3BzB,KAAKE,IAAIyC,Q,EAzDW,CAAL,KA6DpBC,EAAM,IAAI,IAAI,CAClBC,OAAQ,CACN,IAAI,IAAU,CACZC,OAAQ,IAAI,IAAO,CACjBC,MAAO,kBAIbC,OAAQ,MACRC,KAAM,IAAI,IAAK,CACbR,OAAQ,YAAW,EAAE,GAAI,KACzBS,KAAM,MAOV/C,GAAGgD,KAAK,yBAAyBC,MAAK,SAAUC,GAC9CtC,IAAMgC,EAAQ,IAAIlD,EAAY,CAC5BI,SAAUqD,SAASC,QAAQF,EAAIA,EAAGG,QAAQC,YAG5Cb,EAAIc,SAASX,Q","file":"d3.js","sourcesContent":["import Map from '../src/ol/Map.js';\r\nimport SourceState from '../src/ol/source/State.js';\r\nimport Stamen from '../src/ol/source/Stamen.js';\r\nimport View from '../src/ol/View.js';\r\nimport {Layer, Tile as TileLayer} from '../src/ol/layer.js';\r\nimport {fromLonLat, toLonLat} from '../src/ol/proj.js';\r\nimport {getCenter, getWidth} from '../src/ol/extent.js';\r\n\r\nclass CanvasLayer extends Layer {\r\n  constructor(options) {\r\n    super(options);\r\n\r\n    this.features = options.features;\r\n\r\n    this.svg = d3\r\n      .select(document.createElement('div'))\r\n      .append('svg')\r\n      .style('position', 'absolute');\r\n\r\n    this.svg.append('path').datum(this.features).attr('class', 'boundary');\r\n  }\r\n\r\n  getSourceState() {\r\n    return SourceState.READY;\r\n  }\r\n\r\n  render(frameState) {\r\n    const width = frameState.size[0];\r\n    const height = frameState.size[1];\r\n    const projection = frameState.viewState.projection;\r\n    const d3Projection = d3.geoMercator().scale(1).translate([0, 0]);\r\n    let d3Path = d3.geoPath().projection(d3Projection);\r\n\r\n    const pixelBounds = d3Path.bounds(this.features);\r\n    const pixelBoundsWidth = pixelBounds[1][0] - pixelBounds[0][0];\r\n    const pixelBoundsHeight = pixelBounds[1][1] - pixelBounds[0][1];\r\n\r\n    const geoBounds = d3.geoBounds(this.features);\r\n    const geoBoundsLeftBottom = fromLonLat(geoBounds[0], projection);\r\n    const geoBoundsRightTop = fromLonLat(geoBounds[1], projection);\r\n    let geoBoundsWidth = geoBoundsRightTop[0] - geoBoundsLeftBottom[0];\r\n    if (geoBoundsWidth < 0) {\r\n      geoBoundsWidth += getWidth(projection.getExtent());\r\n    }\r\n    const geoBoundsHeight = geoBoundsRightTop[1] - geoBoundsLeftBottom[1];\r\n\r\n    const widthResolution = geoBoundsWidth / pixelBoundsWidth;\r\n    const heightResolution = geoBoundsHeight / pixelBoundsHeight;\r\n    const r = Math.max(widthResolution, heightResolution);\r\n    const scale = r / frameState.viewState.resolution;\r\n\r\n    const center = toLonLat(getCenter(frameState.extent), projection);\r\n    d3Projection\r\n      .scale(scale)\r\n      .center(center)\r\n      .translate([width / 2, height / 2]);\r\n\r\n    d3Path = d3Path.projection(d3Projection);\r\n    d3Path(this.features);\r\n\r\n    this.svg.attr('width', width);\r\n    this.svg.attr('height', height);\r\n\r\n    this.svg.select('path').attr('d', d3Path);\r\n\r\n    return this.svg.node();\r\n  }\r\n}\r\n\r\nconst map = new Map({\r\n  layers: [\r\n    new TileLayer({\r\n      source: new Stamen({\r\n        layer: 'watercolor',\r\n      }),\r\n    }),\r\n  ],\r\n  target: 'map',\r\n  view: new View({\r\n    center: fromLonLat([-97, 38]),\r\n    zoom: 4,\r\n  }),\r\n});\r\n\r\n/**\r\n * Load the topojson data and create an ol/layer/Image for that data.\r\n */\r\nd3.json('data/topojson/us.json').then(function (us) {\r\n  const layer = new CanvasLayer({\r\n    features: topojson.feature(us, us.objects.counties),\r\n  });\r\n\r\n  map.addLayer(layer);\r\n});\r\n"],"sourceRoot":""}